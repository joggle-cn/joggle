<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wuweibi.bullet.mapper.DomainMapper">

	<!--	根据用户ID查询归属域名-->
	<select id="selectByUserId" resultType="com.wuweibi.bullet.domain.vo.DomainVO" parameterType="java.lang.Long">
		select d.id, d.domain,
			   IF(d.type = 2, concat(d.domain,'.',st.server_addr), concat(st.server_addr,':',d.domain)) as domainFull ,
			   d.type, d.status, d.due_time as dueDateTime

		from t_domain  d
	    left join t_server_tunnel st on st.id = d.server_tunnel_id


		where d.user_id = #{userId}
	</select>

<!--	获取可购买的域名列表-->
	<select id="selectBuyList" resultType="com.wuweibi.bullet.domain2.domain.DomainBuyListVO">
		select d.id,
		IF(d.type = 2, concat(d.domain,'.',st.server_addr), concat(st.server_addr,':',d.domain)) as domain ,
		d.type, d.status, d.original_price,d.sales_price,
		st.country tunnelCountry,
		st.area tunnelArea,
		st.name tunnelName,
		st.broadband tunnelBroadband
		from t_domain d
		left join t_server_tunnel st on st.id = d.server_tunnel_id
		<where>
			d.status = 0 and d.user_id is null
			<if test="params.type != null">
				and d.type = #{params.type}
			</if>
				<if test="params.serverTunnelId != null">
				and d.server_tunnel_id = #{params.serverTunnelId}
			</if>
			<if test="params.keyword != null and params.keyword != ''">
				and d.domain like concat(#{params.keyword},'%')
			</if>
		</where>
	</select>

<!--	获取最大的端口号-->
    <select id="selectMaxPort" resultType="java.lang.Integer">
		select max(domain) from t_domain WHERE server_tunnel_id=#{serverTunnelId} and type = 1
	</select>

<!--	获取用户未绑定的域名端口-->
    <select id="selectListNotBindByUserId" resultType="com.wuweibi.bullet.domain2.domain.vo.DomainOptionVO">
		select d.id, d.domain, d.type, st.server_addr serverAddr,
			   IF(d.type = 2, concat(d.domain,'.',st.server_addr), concat(st.server_addr,':',d.domain)) as domainFull
		from t_domain d
		left join t_server_tunnel st on st.id = d.server_tunnel_id
		where d.user_id = #{userId} and d.type=#{type} and d.server_tunnel_id = #{serverTunnelId}
		 and d.id not in (select DISTINCT IFNULL(domain_id,0) from t_device_mapping where userId = #{userId})

	</select>


    <select id="selectDetail" resultType="com.wuweibi.bullet.domain2.domain.DomainDetail">
		select d.*,
			IF(d.type = 2, concat(d.domain,'.',st.server_addr), concat(st.server_addr,':',d.domain)) as domainFull
		from t_domain d
		left join t_server_tunnel st on st.id = d.server_tunnel_id
		where d.id = #{domainId}
	</select>


	<select id="selectDueDomain" resultType="com.alibaba.fastjson.JSONObject">
		 select b.id mappingId, a.domain, a.due_time dueTime,c.deviceId deviceNo  from t_domain a
		 left join t_device_mapping b on a.id = b.domain_id
		 left join t_device c on b.device_id = c.id
		 where a.due_time &lt; SYSDATE() and c.deviceId is not null and b.`status` = 1
	</select>

</mapper>
